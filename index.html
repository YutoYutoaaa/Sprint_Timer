<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Sprint Timer Web Var.Ⅱ</title>
  <style>
    #video-container {
      position: relative;
      max-width: 100%;
      margin-bottom: 16px;
    }
    video {
      width: 100%;
    }
    #guide-wrapper {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 30px; /* ユーザーがタップしやすい幅 */
      left: 50%;
      transform: translateX(-50%);
      cursor: ew-resize;
      touch-action: none;
    }
    #guide-line {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      background-color: red;
      transform: translateX(-50%);
      pointer-events: none;
    }
    #controls {
      margin: 8px 0;
    }
  </style>
</head>
<body>

  <h2>Sprint Timer Web <strong>Var.Ⅱ</strong></h2>

  <input type="file" id="fileInput" accept="video/*">
  <div id="video-container">
    <video id="video" controls></video>
    <div id="guide-wrapper">
      <div id="guide-line"></div>
    </div>
  </div>

  <div id="controls">
    <button id="playBtn">▶ 再生</button>
    <button id="pauseBtn">⏸ 停止</button>
    <button id="process">判定開始</button>
  </div>

  <canvas id="scanCanvas" style="display:none;"></canvas>
  <div id="output"></div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const video = document.getElementById('video');
    const guideWrapper = document.getElementById('guide-wrapper');
    const processButton = document.getElementById('process');
    const scanCanvas = document.getElementById('scanCanvas');
    const output = document.getElementById('output');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');

    let guideX = 0.5; // 初期位置：中央

    // 動画アップロード
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        video.src = url;
      }
    });

    // 再生・停止ボタン
    playBtn.addEventListener('click', () => video.play());
    pauseBtn.addEventListener('click', () => video.pause());

    // 判定ラインのドラッグ移動
    let dragging = false;

    const updateGuideLine = (x, rect) => {
      const ratio = Math.max(0, Math.min(1, x / rect.width));
      guideWrapper.style.left = `${ratio * 100}%`;
      guideX = ratio;
    };

    guideWrapper.addEventListener('mousedown', (e) => {
      dragging = true;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.clientX - rect.left, rect);
    });

    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.clientX - rect.left, rect);
    });

    document.addEventListener('mouseup', () => dragging = false);

    guideWrapper.addEventListener('touchstart', (e) => {
      dragging = true;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.touches[0].clientX - rect.left, rect);
    });

    document.addEventListener('touchmove', (e) => {
      if (!dragging) return;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.touches[0].clientX - rect.left, rect);
    });

    document.addEventListener('touchend', () => dragging = false);

    // 判定処理
    processButton.addEventListener('click', async () => {
      if (!video.duration || video.readyState < 2) {
        alert("動画を読み込んでください。");
        return;
      }

      const fps = 240; // 仮のフレームレート
      const totalFrames = Math.floor(video.duration * fps);

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');

      scanCanvas.width = totalFrames;
      scanCanvas.height = video.videoHeight;
      const scanCtx = scanCanvas.getContext('2d');

      let frame = 0;
      for (let i = 0; i < totalFrames; i++) {
        await new Promise(resolve => {
          video.currentTime = i / fps;
          video.onseeked = () => {
            ctx.drawImage(video, 0, 0);
            const x = Math.floor(canvas.width * guideX);
            const line = ctx.getImageData(x, 0, 1, canvas.height);
            scanCtx.putImageData(line, frame++, 0);
            resolve();
          };
        });
      }

      scanCanvas.style.display = 'block';
      output.innerHTML = "<p>ラインスキャン画像が生成されました。</p>";
    });
  </script>
</body>
</html>
