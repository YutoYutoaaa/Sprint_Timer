<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Sprint Timer Web Var.Ⅴ</title>
  <style>
    #video-container {
      position: relative;
      max-width: 100%;
      margin-bottom: 16px;
    }
    video {
      width: 100%;
    }
    #guide-wrapper {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 30px;
      left: 50%;
      transform: translateX(-50%);
      cursor: ew-resize;
      touch-action: none;
      z-index: 2;
    }
    #guide-line {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 2px;
      background-color: red;
      transform: translateX(-50%);
      pointer-events: none;
    }
    #controls {
      margin: 12px 0;
    }
    button {
      font-size: 20px;
      padding: 12px 24px;
      margin-right: 8px;
    }
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(255, 255, 255, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: #333;
      z-index: 999;
      display: none;
    }
    #rangeSliderContainer {
      display: none;
      margin: 10px 0;
      width: 100%;
    }
    input[type=range] {
      width: 100%;
    }
  </style>
</head>
<body>

  <h2>Sprint Timer Web <strong>Var.Ⅴ</strong></h2>

  <input type="file" id="fileInput" accept="video/*">
  <div id="video-container">
    <video id="video" controls muted></video>
    <div id="guide-wrapper">
      <div id="guide-line"></div>
    </div>
  </div>

  <div id="controls">
    <button id="playBtn">▶ 再生</button>
    <button id="pauseBtn">⏸ 停止</button>
    <button id="rangeMode">🪄 判定範囲モード</button>
    <button id="process">判定開始</button>
  </div>

  <div id="rangeSliderContainer">
    <label>判定範囲：</label>
    <input type="range" id="startRange" min="0" max="100" value="0" step="0.1">
    <input type="range" id="endRange" min="0" max="100" value="5" step="0.1">
  </div>

  <canvas id="scanCanvas" style="display:none;"></canvas>
  <div id="output"></div>
  <div id="loadingOverlay">判定中... しばらくお待ちください</div>

  <script>
    const fileInput = document.getElementById('fileInput');
    const video = document.getElementById('video');
    const guideWrapper = document.getElementById('guide-wrapper');
    const processButton = document.getElementById('process');
    const scanCanvas = document.getElementById('scanCanvas');
    const output = document.getElementById('output');
    const playBtn = document.getElementById('playBtn');
    const pauseBtn = document.getElementById('pauseBtn');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const rangeModeBtn = document.getElementById('rangeMode');
    const rangeSliderContainer = document.getElementById('rangeSliderContainer');
    const startRange = document.getElementById('startRange');
    const endRange = document.getElementById('endRange');

    let guideX = 0.5;
    let dragging = false;
    let duration = 0;

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const url = URL.createObjectURL(file);
        video.src = url;
        video.load();
        video.onloadedmetadata = () => {
          duration = video.duration;
          startRange.max = duration;
          endRange.max = duration;
          endRange.value = Math.min(duration, 5);
        };
      }
    });

    playBtn.addEventListener('click', () => video.play());
    pauseBtn.addEventListener('click', () => video.pause());
    rangeModeBtn.addEventListener('click', () => {
      rangeSliderContainer.style.display = rangeSliderContainer.style.display === 'none' ? 'block' : 'none';
    });

    const updateGuideLine = (x, rect) => {
      const ratio = Math.max(0, Math.min(1, x / rect.width));
      guideWrapper.style.left = `${ratio * 100}%`;
      guideX = ratio;
    };

    const enableInteraction = (enabled) => {
      guideWrapper.style.pointerEvents = enabled ? 'auto' : 'none';
      playBtn.disabled = !enabled;
      pauseBtn.disabled = !enabled;
      fileInput.disabled = !enabled;
      startRange.disabled = !enabled;
      endRange.disabled = !enabled;
    };

    guideWrapper.addEventListener('mousedown', (e) => {
      dragging = true;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.clientX - rect.left, rect);
    });
    document.addEventListener('mousemove', (e) => {
      if (!dragging) return;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.clientX - rect.left, rect);
    });
    document.addEventListener('mouseup', () => dragging = false);

    guideWrapper.addEventListener('touchstart', (e) => {
      dragging = true;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.touches[0].clientX - rect.left, rect);
    });
    document.addEventListener('touchmove', (e) => {
      if (!dragging) return;
      const rect = video.getBoundingClientRect();
      updateGuideLine(e.touches[0].clientX - rect.left, rect);
    });
    document.addEventListener('touchend', () => dragging = false);

    // 範囲スライダーに合わせて動画の該当シーンを表示
    [startRange, endRange].forEach(slider => {
      slider.addEventListener('input', () => {
        video.currentTime = parseFloat(slider.value);
      });
    });

    processButton.addEventListener('click', async () => {
      if (!video.duration || video.readyState < 2) {
        alert("動画を読み込んでください。");
        return;
      }

      const startTime = parseFloat(startRange.value);
      const endTime = parseFloat(endRange.value);
      if (isNaN(startTime) || isNaN(endTime) || startTime >= endTime || startTime < 0 || endTime > video.duration) {
        alert("正しい時間範囲を指定してください。");
        return;
      }

      loadingOverlay.style.display = 'flex';
      enableInteraction(false);

      const fps = 240;
      const startFrame = Math.floor(startTime * fps);
      const endFrame = Math.floor(endTime * fps);

      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');

      scanCanvas.width = endFrame - startFrame;
      scanCanvas.height = video.videoHeight;
      const scanCtx = scanCanvas.getContext('2d');

      let frame = 0;
      for (let i = startFrame; i < endFrame; i++) {
        await new Promise(resolve => {
          video.currentTime = i / fps;
          video.onseeked = () => {
            ctx.drawImage(video, 0, 0);
            const x = Math.floor(canvas.width * guideX);
            const line = ctx.getImageData(x, 0, 1, canvas.height);
            scanCtx.putImageData(line, frame++, 0);
            resolve();
          };
        });
      }

      loadingOverlay.style.display = 'none';
      enableInteraction(true);
      scanCanvas.style.display = 'block';
      output.innerHTML = `<p>ラインスキャン画像が生成されました（${startTime}秒 ～ ${endTime}秒）。</p>`;
    });
  </script>
</body>
</html>
